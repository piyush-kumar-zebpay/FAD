name: Manual Distribution

on:
  workflow_dispatch:
    inputs:
      buildType:
        description: 'Build Type'
        required: true
        default: 'Debug'
        type: choice
        options:
          - Debug
          - Release
      releaseNotes:
        description: 'Release Notes'
        required: true
        default: 'Manual build from GitHub Actions'
      testerGroups:
        description: 'Tester Groups (comma-separated, e.g., qa,devs)'
        required: true
        default: 'qa'

jobs:
  distribute:
    name: Distribute ${{ inputs.buildType }} Build
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3

      - name: Decode Service Account Key
        env:
          FIREBASE_CREDENTIALS: ${{ secrets.FIREBASE_CREDENTIALS_JSON }}
        run: |
          echo "$FIREBASE_CREDENTIALS" > app/app-distribution-service.json

      - name: Make gradlew executable
        run: chmod +x ./gradlew

      - name: Create Release Notes File
        run: |
          mkdir -p app/build
          cat > app/build/release-notes.txt << EOF
          BuildType: ${{ inputs.buildType }}
          Branch: ${{ github.ref_name }}
          Description: ${{ inputs.releaseNotes }}
          Author: ${{ github.actor }}
          Groups: ${{ inputs.testerGroups }}
          EOF

      - name: Build and Upload to Firebase
        env:
          BUILD_TYPE: ${{ inputs.buildType }}
          RELEASE_NOTES: ${{ inputs.releaseNotes }}
          TESTER_GROUPS: ${{ inputs.testerGroups }}
        run: |
          ./gradlew assemble${BUILD_TYPE} appDistributionUpload${BUILD_TYPE} \
            -PfirebaseReleaseNotes="$RELEASE_NOTES" \
            -PfirebaseTesterGroups="$TESTER_GROUPS"
